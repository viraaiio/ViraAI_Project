name: Daily Backup to Backblaze B2

on:
  schedule:
    - cron: "0 */12 * * *"  # run every 12 hours (UTC)
  workflow_dispatch:
    inputs:
      dry_run:
        description: "Run without uploading (validation only)"
        required: false
        default: "false"

concurrency:
  group: backup-b2
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  backup:
    name: Backup repository to B2
    runs-on: ubuntu-latest
    env:
      # Backblaze credentials (must be set in repo Settings → Secrets and variables → Actions)
      B2_KEY_ID: ${{ secrets.B2_KEY_ID }}
      B2_APP_KEY: ${{ secrets.B2_APP_KEY }}
      B2_BUCKET: viraai-backups

      # Paths and naming
      WORK_DIR: /tmp/viraai_backup_work
      SRC_DIR: ${{ github.workspace }}
      ARCHIVE_DIR: /tmp/viraai_backups
      FILTER_FILE: /tmp/viraai_backup_work/excludes.txt

      # Deterministic metadata for archives
      BUILD_DATE: ${{ github.run_id }}
      TZ: UTC

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Preflight validation
        shell: bash
        run: |
          set -euo pipefail
          if [ -z "${B2_KEY_ID:-}" ] || [ -z "${B2_APP_KEY:-}" ]; then
            echo "Missing Backblaze secrets. Ensure B2_KEY_ID and B2_APP_KEY are set." >&2
            exit 1
          fi
          if [ -z "${B2_BUCKET:-}" ]; then
            echo "Missing B2 bucket name." >&2
            exit 1
          fi
          echo "Preflight OK. Proceeding."

      - name: Install dependencies (rclone, tar, gzip, coreutils)
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y tar gzip coreutils
          curl -fsSL https://rclone.org/install.sh | sudo bash
          rclone version

      - name: Configure rclone (non-interactive)
        shell: bash
        run: |
          set -euo pipefail
          rclone config create viraai-b2 b2 account "$B2_KEY_ID" key "$B2_APP_KEY" --non-interactive
          # Sanity check: list buckets (will fail if creds invalid)
          rclone lsd viraai-b2: | sed 's/.*//'

      - name: Prepare workspace and exclusions
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "$WORK_DIR" "$ARCHIVE_DIR"
          # Exclusions: common CI/build/vendor caches and VCS
          cat > "$FILTER_FILE" <<'EOF'
          - .git/**
          - .github/**
          - node_modules/**
          - .next/**
          - dist/**
          - coverage/**
          - .cache/**
          - **/*.bak
          - **/.DS_Store
          EOF
          echo "Exclusion rules created at $FILTER_FILE"

      - name: Create deterministic source archive
        shell: bash
        working-directory: ${{ env.SRC_DIR }}
        run: |
          set -euo pipefail
          TS=$(date -u +"%Y-%m-%d_%H-%M-%S")
          ARCHIVE_NAME="src-${TS}.tar.gz"
          # Create a file list honoring filters (portable approach)
          # Use find + grep -v with patterns for simplicity on runner
          find . -type f \
            | grep -Ev '(^\./\.git/|^\./\.github/|^\./node_modules/|^\./\.next/|^\./dist/|^\./coverage/|^\./\.cache/|\.bak$|\.DS_Store$)' \
            > "$WORK_DIR/include_files.txt"

          # Create deterministic tar (fixed mtime/owner/group, numeric IDs)
          tar \
            --mtime="UTC 2000-01-01" \
            --owner=0 --group=0 --numeric-owner \
            --posix \
            -czf "$ARCHIVE_DIR/$ARCHIVE_NAME" \
            --files-from "$WORK_DIR/include_files.txt"

          echo "Archive created: $ARCHIVE_DIR/$ARCHIVE_NAME"

      - name: Generate checksum manifest
        shell: bash
        run: |
          set -euo pipefail
          cd "$ARCHIVE_DIR"
          sha256sum *.tar.gz > SHA256SUMS.txt
          ls -lh

      - name: Upload to B2 (rclone)
        if: ${{ github.event.inputs.dry_run != 'true' }}
        shell: bash
        run: |
          set -euo pipefail
          TS_PATH=$(date -u +"%Y/%m/%d")
          DEST="viraai-b2:${B2_BUCKET}/repo-backups/${{ github.ref_name }}/${TS_PATH}/"
          rclone copy "$ARCHIVE_DIR" "$DEST" \
            --transfers=4 \
            --checkers=8 \
            --fast-list \
            --checksum \
            --b2-version-at=now \
            --log-level INFO
          echo "Uploaded to: $DEST"

      - name: Verify upload (list latest files)
        if: ${{ github.event.inputs.dry_run != 'true' }}
        shell: bash
        run: |
          set -euo pipefail
          TS_PATH=$(date -u +"%Y/%m/%d")
          DEST="viraai-b2:${B2_BUCKET}/repo-backups/${{ github.ref_name }}/${TS_PATH}/"
          rclone ls "$DEST" | tail -n 20

      - name: Upload artifacts (archives and manifest)
        uses: actions/upload-artifact@v4
        with:
          name: backup-${{ github.run_number }}
          path: |
            ${{ env.ARCHIVE_DIR }}/*.tar.gz
            ${{ env.ARCHIVE_DIR }}/SHA256SUMS.txt
          retention-days: 7

      - name: Cleanup workspace
        if: always()
        shell: bash
        run: |
          rm -rf "$WORK_DIR" "$ARCHIVE_DIR" || true
